name: Update LinkedIn Resume

on:
  # Run weekly on Sundays at 6 AM UTC
  schedule:
    - cron: '0 6 * * 0'
  
  # Allow manual triggering
  workflow_dispatch:
  
  # Run on pushes to main branch (for testing)
  push:
    branches: [ main ]

env:
  PYTHON_VERSION: '3.11'

jobs:
  scrape-and-deploy:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # Required to push changes back to repository
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        playwright install chromium
        
    - name: Configure environment
      env:
        LINKEDIN_EMAIL: ${{ secrets.LINKEDIN_EMAIL }}
        LINKEDIN_PASSWORD: ${{ secrets.LINKEDIN_PASSWORD }}
        LINKEDIN_TOTP_SECRET: ${{ secrets.LINKEDIN_TOTP_SECRET }}
      run: |
        echo "LINKEDIN_EMAIL=$LINKEDIN_EMAIL" >> $GITHUB_ENV
        echo "LINKEDIN_PASSWORD=$LINKEDIN_PASSWORD" >> $GITHUB_ENV
        echo "LINKEDIN_TOTP_SECRET=$LINKEDIN_TOTP_SECRET" >> $GITHUB_ENV
        
    - name: Scrape LinkedIn profile
      run: |
        python scrape_linkedin.py
      env:
        LINKEDIN_EMAIL: ${{ secrets.LINKEDIN_EMAIL }}
        LINKEDIN_PASSWORD: ${{ secrets.LINKEDIN_PASSWORD }}
        LINKEDIN_TOTP_SECRET: ${{ secrets.LINKEDIN_TOTP_SECRET }}
        
    - name: Generate resume markdown
      run: |
        python generate_markdown.py
        
    - name: Check for changes
      id: verify-changed-files
      run: |
        if [ -n "$(git status --porcelain)" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          git status --porcelain
        else
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "No changes detected"
        fi
        
    - name: Commit and push changes
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Add generated files
        git add linkedin_data.json resume.md index.md
        
        # Create commit with timestamp
        git commit -m "Update resume from LinkedIn profile - $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
        
        # Push changes
        git push
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: resume-files
        path: |
          linkedin_data.json
          resume.md
          index.md
        retention-days: 30
        
    - name: Deploy to GitHub Pages (if enabled)
      if: steps.verify-changed-files.outputs.changed == 'true'
      run: |
        echo "Resume updated and committed. If GitHub Pages is enabled, it will deploy automatically."
        echo "Visit your repository's Pages settings to enable GitHub Pages deployment from the main branch."